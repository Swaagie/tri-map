<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Demo map</title>
    <link href="assets/css/solid.css" rel="stylesheet" />
    <link href="assets/css/fontawesome.css" rel="stylesheet" />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/mapbox-gl-style-switcher@1.0.11/styles.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --red: #fd5959;
        --orange: #ff9c6d;
        --yellow: #fcff82;
        --blue: #007cbf;
        --gray: #aaaaaa;
        --green: #90ee90;
      }

      body {
        margin: 0;
      }

      .grid-container {
        display: grid;
        column-gap: 0em;
        row-gap: 1em;
      }

      .grid-item {
        height: 100vh;
      }

      #map-all {
        display: block;
        width: 100%;
        height: 100%;
      }

      #start {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .legend {
        background-color: #fff;
        border-radius: 3px;
        bottom: 4em;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        padding: 2em;
        position: absolute;
        right: 2em;
        z-index: 1;
      }

      .legend h2 {
        margin-top: 0;
      }

      .legend ul {
        /* list-style: none; */
        padding: 1em;
      }

      .legend span {
        display: inline-block;
        height: 1em;
        width: 1em;
        border: 1px solid var(--grey);
        vertical-align: sub;
      }

      .marker {
        border-radius: 0.5em;
        padding: 0 1em;
      }

      .buoy {
        color: var(--green);
        border: 2px solid #333;
        border-radius: 50%;
      }
    </style>
  </head>
  <body>
    <div class="grid-container">
      <div class="grid-item">
        <div id="map-all"></div>
        <div class="legend">
          <h2>Zwemparcours</h2>
          <div>
            <span style="background: var(--green)"></span>
            <i class="fa-solid fa-person-swimming"></i> start
          </div>
          <div>
            <span style="background: var(--red)"></span>
            <i class="fa-solid fa-circle"></i> keerboeien
          </div>
          <div>
            <span style="background: var(--gray)"></span>
            <i class="fa-solid fa-stopwatch"></i> meetpunt transitie 1
          </div>
          <ul>
            <li>500 meter</li>
            <li>1 ronde</li>
            <li>Leekstermeer</li>
          </ul>
          <h2>Route flyby</h2>
          <i class="fa-solid fa-play" id="flyby-start"></i>
          <i class="fa-solid fa-stop" id="flyby-stop"></i>
        </div>
      </div>
      <div class="grid-item">
        <div id="map-swim"></div>
      </div>
      <div class="grid-item">
        <div id="map-bike"></div>
      </div>
      <div class="grid-item">
        <div id="map-run"></div>
      </div>
    </div>
    <!-- Add mapbox -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script>
      (async function main() {
        mapboxgl.accessToken =
          'pk.eyJ1Ijoic3dhYWdpZSIsImEiOiJja3phY3JjdXgyMW5vMndyeGtma2d6NWxkIn0.sVSiLelg5k2XwpdokGxYUQ';

        const map = new mapboxgl.Map({
          container: 'map-all', // container ID
          style: 'mapbox://styles/mapbox/outdoors-v11', // style URL
          center: [6.51314, 53.2065], // starting position [lng, lat]
          zoom: 12, // starting zoom
        });

        const data = await fetchSourceFromGithub('speedman-divisies.json');
        // const data = await fetchSourceFromGithub('zwemmen_1_8.json');
        // const dataTransitie = await fetchSourceFromGithub('transitie.json');

        // Get style switcher, nasty import
        // window.exports = {};
        // await import(
        //   'https://unpkg.com/mapbox-gl-style-switcher@1.0.11/dist/index.js'
        // );
        // const { MapboxStyleSwitcherControl } = exports;

        // Use style control
        // map.addControl(
        //   new MapboxStyleSwitcherControl(null, {
        //     defaultStyle: 'Outdoors',
        //     eventListeners: {
        //       onChange: () => {
        //         map.once('styledata', render);
        //       },
        //     },
        //   })
        // );

        // Navigation controls
        // map.addControl(new mapboxgl.NavigationControl());

        async function fetchSourceFromGithub(url) {
          const response = await fetch(
            `https://api.github.com/repos/swaagie/tri-map/contents/data/${url}`,
            {
              credentials: 'omit',
              headers: {
                Accept: 'application/vnd.github.v3.raw',
              },
            }
          );

          return await response.json();
        }

        function getBoundingBox(coordinates = []) {
          // Create a 'LngLatBounds' with both corners at the first coordinate.
          const bounds = new mapboxgl.LngLatBounds(coordinates.slice(0, 2));

          // Extend the 'LngLatBounds' to include every coordinate in the bounds result.
          for (const coord of coordinates) {
            bounds.extend(coord);
          }

          return bounds;
        }

        function point({ properties, geometry }, n) {
          // Create a DOM element for each marker.
          const el = document.createElement('div');
          el.innerHTML = properties.description || properties.beschrijving;
          el.className = 'marker';
          el.style.border = `2px solid ${properties.borderColor || '#333'}`;
          el.style.color = properties.color || '#333';
          // el.style.background = properties.backgroundColor || '#333';

          // Add markers to the map.
          new mapboxgl.Marker(el).setLngLat(geometry.coordinates).addTo(map);
        }

        function linestring({ properties, geometry }, n) {
          map.addLayer({
            id: 'layer-' + n,
            type: 'line',
            source: 'triathlon' + n,
            layout: {
              'line-join': 'round',
              'line-cap': 'round',
            },
            paint: {
              'line-color': properties.stroke,
              'line-width': properties['stroke-width'],
              'line-opacity': properties['stroke-opacity'],
            },
          });

          map.addLayer({
            id: n + '-arrows',
            type: 'symbol',
            source: 'triathlon' + n,
            layout: {
              'symbol-placement': 'line',
              'text-field': 'âžž',
              'text-size': [
                'interpolate',
                ['linear'],
                ['zoom'],
                20,
                24,
                22,
                60,
              ],
              'symbol-spacing': [
                'interpolate',
                ['linear'],
                ['zoom'],
                12,
                30,
                22,
                160,
              ],
              'text-keep-upright': false,
            },
            paint: {
              'text-color': properties.stroke,
              'text-halo-color': '#333',
              'text-halo-width': 1,
            },
          });
        }

        function polygon({ properties, geometry }, n) {
          map.addLayer({
            id: 'layer-' + n,
            type: 'fill',
            source: 'triathlon' + n,
            layout: {},
            paint: {
              'fill-color': properties.fill,
              'fill-opacity': properties['fill-opacity'],
            },
          });

          map.addLayer({
            id: n + '-line',
            type: 'line',
            source: 'triathlon' + n,
            layout: {},
            paint: {
              'line-color': properties.stroke,
              'line-width': properties['stroke-width'],
            },
          });
        }

        const renderers = {
          Point: point,
          LineString: linestring,
          Polygon: polygon,
        };

        map.once('load', render);

        function render() {
          console.log('RENDERING');

          // Loop over all features
          data.features.forEach((feature, n) => {
            // Add all data
            map.addSource('triathlon' + n, {
              type: 'geojson',
              data: feature,
            });

            renderers[feature.geometry.type](feature, n);
          });

          // Calculate bounding box, normalize per feature
          map.fitBounds(
            getBoundingBox(
              data.features.reduce((acc, feature) => {
                let coordinates = [];

                switch (feature.geometry.type) {
                  case 'Point':
                    coordinates = [feature.geometry.coordinates];
                    break;
                  case 'LineString':
                    coordinates = feature.geometry.coordinates;
                    break;
                  case 'Polygon':
                    coordinates = feature.geometry.coordinates[0];
                    break;
                }

                acc.push.apply(acc, coordinates);
                return acc;
              }, [])
            ),
            {
              padding: 100,
            }
          );
        }
      })();
    </script>
  </body>
</html>
