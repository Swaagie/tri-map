<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Demo map</title>
    <link href="assets/css/solid.css" rel="stylesheet" />
    <link href="assets/css/fontawesome.css" rel="stylesheet" />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/mapbox-gl-style-switcher@1.0.11/styles.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --red: #fd5959;
        --orange: #ff9c6d;
        --yellow: #fcff82;
        --blue: #007cbf;
        --gray: #aaaaaa;
        --green: #90ee90;
      }

      body {
        margin: 0;
      }

      .grid-container {
        display: grid;
        column-gap: 0em;
        row-gap: 1em;
      }

      .grid-item {
        height: 100vh;
      }

      #map-all {
        display: block;
        width: 100%;
        height: 100%;
      }

      .legend {
        background-color: whitesmoke;
        border-radius: 3px;
        top: 2em;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        padding: 2em;
        position: absolute;
        left: 2em;
        z-index: 1;
      }

      .legend h2 {
        margin-top: 0;
      }

      .legend ul {
        /* list-style: none; */
        padding: 1em;
      }

      .legend span {
        display: inline-block;
        height: 1em;
        width: 1em;
        border: 1px solid var(--grey);
        vertical-align: sub;
      }

      summary {
        font-size: 16px;
      }

      .marker {
        font-size: 16px;
        background: whitesmoke;
        padding: 4px;
        border: 1px solid #ccc;
        border-radius: 50%;
      }
    </style>
  </head>
  <body>
    <div class="grid-container">
      <div class="grid-item">
        <div id="map-all"></div>
        <div class="legend">
          <h1>050media Speedman triatlon Groningen</h1>
          <details>
            <summary><b>Wisselzone</b></summary>
            <div>
              <p>
                <b>N.B: Parkeren bij P+R Transferium Hoogkerk</b><br />
                Inschrijving noordzijde nabij tennisvereniging
              </p>
              <ul>
                <li>
                  <i
                    class="fa-solid fa-check-circle"
                    style="color: #424242"
                  ></i>
                  Check in/out
                </li>
              </ul>
            </div>
          </details>
          <details>
            <summary><b>Zwemparcours</b></summary>
            <div>
              <p>
                <b>Sprint/standaard divisies:</b> ronde 750 meter<br />
                <b>Sprint:</b> 1 ronde<br />
                <b>Standaard:</b> 2 ronden<br /><br />

                <b>Achtste/kwart individueel/estafette:</b> ronde 500 meter<br />
                <b>Achtste:</b> 1 ronde<br />
                <b>Kwart:</b> 2 ronden<br /><br />

                <b>Locatie:</b> Ruskenveenseplas
              </p>
              <h3>Legenda</h3>
              <ul>
                <li>
                  <i
                    class="fa-solid fa-person-swimming"
                    style="color: #0288d1"
                  ></i>
                  Start
                </li>
                <li>
                  <i class="fa-solid fa-circle" style="color: #ffd600"></i>
                  Boeien
                </li>
                <li>
                  <i
                    class="fa-solid fa-flag-checkered"
                    style="color: #0288d1"
                  ></i>
                  Finish zwemmen
                </li>
                <li>
                  <i class="fa-solid fa-stopwatch" style="color: #424242"></i>
                  Transitie
                </li>
              </ul>
            </div>
          </details>
          <details>
            <summary><b>Fietsparcours</b></summary>
            <div>
              <p>
                <b>Aanloopstrook:</b> 1.5 kilometer<br />
                <b>Ronde:</b> 10.6 kilometer<br /><br />

                <b>Achtste/sprint:</b> 2 ronden<br />
                <b>Kwart/standaard:</b> 4 ronden<br />
              </p>
              <h3>Legenda</h3>
              <ul>
                <li>
                  <i
                    class="fa-solid fa-arrow-circle-left"
                    style="color: #a52714"
                  ></i>
                  Keerpunt
                </li>
                <li>
                  <i class="fa-solid fa-warning" style="color: #ff5252"></i>
                  Aandachtspunten
                </li>
                <li>
                  <i
                    class="fa-solid fa-hourglass-half"
                    style="color: #ff5252"
                  ></i>
                  Penaltybox
                </li>
                <li>
                  <i class="fa-solid fa-stopwatch" style="color: #424242"></i>
                  Transitie
                </li>
              </ul>
            </div>
          </details>
          <details>
            <summary><b>Loopparcours</b></summary>
            <div>
              <p>
                <b>Ronde:</b> 2.6 kilometer<br /><br />

                <b>Achtste/sprint:</b> 2 ronden<br />
                <b>Kwart/standaard:</b> 4 ronden<br />
              </p>
              <h3>Legenda</h3>
              <ul>
                <li>
                  <i class="fa-solid fa-stopwatch" style="color: #424242"></i>
                  Transitie
                </li>
                <li>
                  <i
                    class="fa-solid fa-flag-checkered"
                    style="color: #097138"
                  ></i>
                  Finish
                </li>
              </ul>
            </div>
          </details>
        </div>
      </div>
    </div>
    <!-- Add mapbox -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script>
      // Enable use of style switcher without needing bundler (barf)
      window.exports = {};
    </script>
    <script src="https://unpkg.com/mapbox-gl-style-switcher@1.0.11/dist/index.js"></script>
    <script>
      (async function main() {
        mapboxgl.accessToken =
          'pk.eyJ1Ijoic3dhYWdpZSIsImEiOiJja3phY3JjdXgyMW5vMndyeGtma2d6NWxkIn0.sVSiLelg5k2XwpdokGxYUQ';

        const map = new mapboxgl.Map({
          container: 'map-all', // container ID
          style: 'mapbox://styles/mapbox/outdoors-v11', // style URL
          center: [6.51314, 53.2065], // starting position [lng, lat] = Groningen
          zoom: 12, // starting zoom
        });

        const query = new URL(window.location).searchParams.get('course');
        const data = await fetchSourceFromGithub(
          `speedman-${query || 'divisies'}.json`
        );

        const MapboxStyleSwitcherControl = exports.MapboxStyleSwitcherControl;

        // Use style control
        map.addControl(
          new MapboxStyleSwitcherControl(null, {
            defaultStyle: 'Outdoors',
            eventListeners: {
              onChange: () => {
                map.once('styledata', render);
              },
            },
          })
        );

        // Navigation controls
        map.addControl(new mapboxgl.NavigationControl());

        async function fetchSourceFromGithub(url) {
          const response = await fetch(
            `https://api.github.com/repos/swaagie/tri-map/contents/data/${url}`,
            {
              credentials: 'omit',
              headers: {
                Accept: 'application/vnd.github.v3.raw',
              },
            }
          );

          return await response.json();
        }

        function getBoundingBox(coordinates = []) {
          // Create a 'LngLatBounds' with both corners at the first coordinate.
          const bounds = new mapboxgl.LngLatBounds(coordinates.slice(0, 2));

          // Extend the 'LngLatBounds' to include every coordinate in the bounds result.
          for (const coord of coordinates) {
            bounds.extend(coord);
          }

          return bounds;
        }

        function point({ properties, geometry }, n) {
          // Create a DOM element for each marker.
          const el = document.createElement('span');
          el.className = `marker fa-solid ${properties.name}`;
          el.style.color = `#${properties.styleUrl.split('-')[2] || '333'}`;

          // Add markers with popups to the map.
          if (properties.beschrijving || properties.description) {
            new mapboxgl.Marker(el)
              .setLngLat(geometry.coordinates)
              .setPopup(
                new mapboxgl.Popup({ offset: 25 }) // add popups
                  .setHTML(
                    `<span>${
                      properties.beschrijving || properties.description
                    }</span>`
                  )
              )
              .addTo(map);
          } else {
            // Add markers with popups to the map.
            new mapboxgl.Marker(el).setLngLat(geometry.coordinates).addTo(map);
          }
        }

        function linestring({ properties, geometry }, n) {
          // Route
          map.addLayer({
            id: 'layer-' + n,
            type: 'line',
            source: 'triathlon' + n,
            layout: {
              'line-join': 'round',
              'line-cap': 'round',
            },
            paint: {
              'line-color': properties.stroke,
              'line-width': properties['stroke-width'],
              'line-opacity': properties['stroke-opacity'],
            },
          });

          // Direction arrows
          map.addLayer({
            id: n + '-arrows',
            type: 'symbol',
            source: 'triathlon' + n,
            layout: {
              'symbol-placement': 'line',
              'text-field': 'âžž',
              'text-size': [
                'interpolate',
                ['linear'],
                ['zoom'],
                20,
                24,
                22,
                60,
              ],
              'symbol-spacing': [
                'interpolate',
                ['linear'],
                ['zoom'],
                12,
                30,
                22,
                160,
              ],
              'text-keep-upright': false,
            },
            paint: {
              'text-color': properties.stroke,
              'text-halo-color': '#333',
              'text-halo-width': 1,
            },
          });
        }

        function polygon({ properties, geometry }, n) {
          // Polygon outline
          map.addLayer({
            id: 'layer-' + n,
            type: 'fill',
            source: 'triathlon' + n,
            layout: {},
            paint: {
              'fill-color': properties.fill,
              'fill-opacity': properties['fill-opacity'],
            },
          });

          // Polygon fill
          map.addLayer({
            id: n + '-line',
            type: 'line',
            source: 'triathlon' + n,
            layout: {},
            paint: {
              'line-color': properties.stroke,
              'line-width': properties['stroke-width'],
            },
          });

          // Text labels on polygons
          map.addLayer({
            id: 'poi-labels-' + n,
            type: 'symbol',
            source: 'triathlon' + n,
            layout: {
              'text-field': ['get', 'beschrijving'],
              'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
              'text-justify': 'center',
            },
          });
        }

        const renderers = {
          Point: point,
          LineString: linestring,
          Polygon: polygon,
        };

        map.once('load', render);

        function render() {
          // Loop over all features
          data.features.forEach((feature, n) => {
            // Add all data
            map.addSource('triathlon' + n, {
              type: 'geojson',
              data: feature,
            });

            renderers[feature.geometry.type](feature, n);
          });
        }

        // Calculate bounding box, normalize per feature
        map.fitBounds(
          getBoundingBox(
            data.features.reduce((acc, feature) => {
              let coordinates = [];

              switch (feature.geometry.type) {
                case 'Point':
                  coordinates = [feature.geometry.coordinates];
                  break;
                case 'LineString':
                  coordinates = feature.geometry.coordinates;
                  break;
                case 'Polygon':
                  coordinates = feature.geometry.coordinates[0];
                  break;
              }

              acc.push.apply(acc, coordinates);
              return acc;
            }, [])
          ),
          {
            padding: 50,
          }
        );
      })();
    </script>
  </body>
</html>
